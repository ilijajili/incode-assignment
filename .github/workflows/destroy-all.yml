name: Destroy All

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "destroy all" to confirm destroy-all.'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
  TF_BACKEND_BUCKET: ${{ vars.TERRAFORM_STATE_BUCKET }}
  TF_BACKEND_DYNAMODB_TABLE: ${{ vars.TERRAFORM_STATE_LOCK_TABLE }}
  TF_BACKEND_KEY: ${{ vars.TERRAFORM_STATE_KEY }}
  TF_VAR_aws_region: ${{ vars.AWS_REGION }}
  TF_VAR_github_actions_role_arn: ${{ secrets.OIDC }}
  TF_VAR_db_username: ${{ vars.DB_USERNAME }}
  TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

jobs:
  destroy:
    runs-on: ubuntu-latest

    steps:
      - name: Verify confirmation phrase
        if: ${{ github.event.inputs.confirmation != 'destroy all' }}
        run: |
          echo 'Destroy All requires the exact confirmation phrase: "destroy all"'
          exit 1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
          cli_config_credentials_hostname: none
          terraform_version: latest

      - name: Clear Terraform plugin cache
        run: rm -rf ~/.terraform.d/plugin-cache

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Clean Terraform local cache
        working-directory: infra/terraform
        run: |
          rm -rf .terraform
          rm -f .terraform.lock.hcl

      - name: Terraform init (lock disabled)
        working-directory: infra/terraform
        run: |
          terraform init -lock=false \
            -backend-config="bucket=${TF_BACKEND_BUCKET}" \
            -backend-config="dynamodb_table=${TF_BACKEND_DYNAMODB_TABLE}" \
            -backend-config="key=${TF_BACKEND_KEY}" \
            -backend-config="region=${AWS_REGION}"

      - name: Terraform plan destroy (lock disabled)
        working-directory: infra/terraform
        run: terraform plan -destroy -lock=false -input=false

      - name: Terraform destroy (lock disabled)
        working-directory: infra/terraform
        run: terraform apply -destroy -lock=false -input=false -auto-approve
